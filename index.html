<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Laikipia Anonymous Chatroom</title>
<style>
:root{ --gold:#D4AF37; --gold-dark:#a78123; --bg:#FFF9ED; --accent:#2b6cb0; }
*{box-sizing:border-box;margin:0;padding:0;font-family:Inter,system-ui,Arial,sans-serif}
html,body{height:100%;}
body{display:flex;flex-direction:column;background:linear-gradient(180deg,#fffaf0,var(--bg));color:#111}
header{padding:12px 16px;background:linear-gradient(90deg,var(--gold),var(--gold-dark));color:#111;font-weight:700;position:relative;box-shadow:0 2px 10px rgba(0,0,0,0.08)}
.sub{font-weight:600;font-size:16px}
#logout{position:absolute;right:12px;top:10px;font-size:13px;color:#111;background:rgba(255,255,255,0.6);padding:6px 8px;border-radius:8px;cursor:pointer}
#status{font-size:13px;color:#111;opacity:0.95;margin-top:6px}
.container{display:flex;flex:1;gap:12px;padding:12px}
.sidebar{width:260px;background:rgba(255,255,255,0.6);border-radius:14px;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06);display:flex;flex-direction:column;gap:10px}
#usersList{overflow:auto;flex:1}
.userRow{display:flex;gap:10px;align-items:center;padding:8px;border-radius:10px;cursor:pointer}
.userRow:hover{background:rgba(0,0,0,0.03)}
.avatar{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff}
.userMeta{font-size:13px}
.userName{font-weight:700}
.userStatus{font-size:12px;color:#666}
.main{flex:1;display:flex;flex-direction:column}
#chatBox{flex:1;overflow-y:auto;padding:18px;display:flex;flex-direction:column;gap:12px;border-radius:12px;background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="300"><rect width="100%" height="100%" fill="%23fff7ea"/></svg>');}
.bubble{padding:12px 14px;max-width:72%;border-radius:18px;box-shadow:0 6px 14px rgba(0,0,0,0.06);word-break:break-word;animation:pop .12s ease}
.mine{margin-left:auto;background:linear-gradient(180deg,#fff7e6,#fff5df);border-bottom-right-radius:6px;text-align:right}
.other{margin-right:auto;background:#ffffff;border-bottom-left-radius:6px;text-align:left}
.msgHeader{display:flex;gap:8px;align-items:center}
.msgText{margin-top:6px;font-size:15px}
.msgMeta{display:flex;gap:8px;align-items:center;justify-content:flex-end;font-size:12px;color:#666;margin-top:8px}
.small{font-size:12px;color:#777}
#bar{display:flex;padding:12px;gap:8px;background:transparent;align-items:center}
#msgInput{flex:1;padding:12px 14px;border-radius:18px;border:1px solid rgba(0,0,0,0.09);outline:none;font-size:15px;background:rgba(255,255,255,0.9)}
#sendBtn{background:linear-gradient(90deg,var(--gold),var(--gold-dark));border:none;padding:10px 16px;border-radius:18px;font-weight:700;cursor:pointer;color:#111}
.fileBtn{background:transparent;border:1px dashed rgba(0,0,0,0.06);padding:8px;border-radius:10px;cursor:pointer}
.typing{font-size:13px;color:#444;padding:6px 12px}
audio{max-width:250px;display:block;margin-top:6px;border-radius:12px}
@keyframes pop{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
.footerNote{font-size:12px;color:#666;text-align:center;padding:6px}
@media(max-width:860px){.container{padding:8px}.sidebar{display:none}.bubble{max-width:86%}}
</style>
</head>
<body>

<div id="authContainer">
  <h2>Login / Register</h2>
  <input type="email" id="emailInput" placeholder="Email" />
  <input type="password" id="passwordInput" placeholder="Password" />
  <button id="loginBtn">Login</button>
  <button id="registerBtn">Register</button>
  <div id="authStatus"></div>
</div>

<div id="chatContainer" style="display:none">
<header>
  <div class="sub">Laikipia Anonymous Chatroom</div>
  <div id="logout">Logout</div>
  <div id="status">Loading chatâ€¦</div>
</header>
<div class="container">
  <aside class="sidebar">
    <div style="font-weight:800">Contacts</div>
    <div id="usersList"></div>
    <div class="footerNote">Online indicator, avatars, seen ticks, typing & image/voice uploads enabled</div>
  </aside>
  <main class="main">
    <div id="chatBox" aria-live="polite"></div>
    <div class="typing" id="typingIndicator" style="display:none">Someone is typingâ€¦</div>
    <div id="bar">
      <input id="fileInput" type="file" accept="image/*" style="display:none" />
      <button id="attachBtn" class="fileBtn" title="Attach image">ðŸ“Ž</button>
      <input id="msgInput" type="text" placeholder="Type your message..." autocomplete="off" />
      <button id="sendBtn">Send</button>
    </div>
  </main>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
import { getDatabase, ref, push, onChildAdded, query, limitToLast, set, onValue, onDisconnect } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";
import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

const FIREBASE_CONFIG = {
  apiKey: "AIzaSyDxrcdSofjGYjHVihYIFJHOF0VjCQjsKN4",
  authDomain: "laikipia-49112.firebaseapp.com",
  projectId: "laikipia-49112",
  storageBucket: "laikipia-49112.firebasestorage.app",
  messagingSenderId: "677277411058",
  appId: "1:677277411058:web:f9da4a4e56d58fc442526b",
  measurementId: "G-NM0C5G42DP"
};

const app = initializeApp(FIREBASE_CONFIG);
const analytics = getAnalytics(app);
const db = getDatabase(app);
const auth = getAuth(app);

const nameWords1 = ["Silver","Blue","Golden","Silent","Rapid","Misty","Shadow","Bright","Wild","Crimson"];
const nameWords2 = ["Falcon","Leaf","River","Lion","Wolf","Star","Cloud","Hawk","Dune","Comet"];
function generateAnonName(){
  const w1 = nameWords1[Math.floor(Math.random()*nameWords1.length)];
  const w2 = nameWords2[Math.floor(Math.random()*nameWords2.length)];
  return w1 + " " + w2;
}

const adminEmail = "admin@laikipia.ac.ke";

// AUTH ELEMENTS
const loginBtn = document.getElementById('loginBtn');
const registerBtn = document.getElementById('registerBtn');
const emailInput = document.getElementById('emailInput');
const passwordInput = document.getElementById('passwordInput');
const authStatus = document.getElementById('authStatus');
const authContainer = document.getElementById('authContainer');
const chatContainer = document.getElementById('chatContainer');

async function register(){
  try{
    const userCredential = await createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
    const user = userCredential.user;
    const anonName = generateAnonName();
    const isAdmin = user.email === adminEmail;
    await updateProfile(user, { displayName: anonName });
    await set(ref(db, `users/${user.uid}`), { email: isAdmin ? user.email : null, anonName, isAdmin });
    authContainer.style.display='none';
    chatContainer.style.display='block';
    attachMessagesListener();
  }catch(e){ authStatus.textContent = e.message; }
}

async function login(){
  try{
    const userCredential = await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
    const user = userCredential.user;
    authContainer.style.display='none';
    chatContainer.style.display='block';
    attachMessagesListener();
  }catch(e){ authStatus.textContent = e.message; }
}

registerBtn.onclick = register;
loginBtn.onclick = login;

onAuthStateChanged(auth, user => {
  if(user){
    authContainer.style.display='none';
    chatContainer.style.display='block';
  } else {
    authContainer.style.display='block';
    chatContainer.style.display='none';
  }
});

// LOGOUT
document.getElementById('logout').onclick = ()=>{
  signOut(auth).then(()=>{ location.reload(); });
};

// --- CHAT MESSAGING LOGIC ---
function attachMessagesListener(){
  const messagesRef = ref(db, 'messages');
  const recentQuery = query(messagesRef, limitToLast(500));
  onChildAdded(recentQuery, snapshot => {
    const key = snapshot.key;
    const msg = snapshot.val();
    if(!msg) return;
    addBubble(msg, key);
  });
}

function addBubble(msg, key){
  const chatBox = document.getElementById('chatBox');
  if(document.getElementById('msg-'+key)) return;
  const me = auth.currentUser;
  const isMine = me && msg.uid === me.uid;
  const wrap = document.createElement('div');
  wrap.id = 'msg-'+key;
  wrap.className = 'bubble ' + (isMine ? 'mine' : 'other');
  const header = document.createElement('div');
  header.className='msgHeader';
  const nameWrap = document.createElement('div');
  const displayName = msg.anonName || 'Anonymous';
  nameWrap.innerHTML = `<div class='userName'>${displayName}</div>`;
  header.appendChild(nameWrap);
  const text = document.createElement('div');
  text.className='msgText';
  text.textContent = msg.text;
  const meta = document.createElement('div');
  meta.className='msgMeta';
  meta.textContent = new Date(msg.ts||Date.now()).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
  wrap.appendChild(header);
  wrap.appendChild(text);
  wrap.appendChild(meta);
  chatBox.appendChild(wrap);
  chatBox.scrollTop = chatBox.scrollHeight;
}

// SEND MESSAGE
document.getElementById('sendBtn').onclick = async ()=>{
  const input = document.getElementById('msgInput');
  const text = input.value.trim();
  if(!text) return;
  const user = auth.currentUser;
  await push(ref(db,'messages'),{
    uid: user.uid,
    anonName: user.displayName,
    text,
    ts: Date.now()
  });
  input.value='';
};

</script>
</body>
</html>
